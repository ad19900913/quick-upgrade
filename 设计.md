 

 

 

 

# ***\*简洁升级概要\*******\*设计\****

 

 

 

 

 

 

 

 

 

 

 

 

![img](F:\projects\quick-upgrade\wps1.jpg) 

***\*锐明技术股份有限公司\****

 

 



***\*修订记录\****

| 日期          | 版本号  | 描述 | 作者 |
| ------------- | ------- | ---- | ---- |
| 2025年2月21日 | V2.16.5 |      | 陈刚 |
|               |         |      |      |
|               |         |      |      |
|               |         |      |      |
|               |         |      |      |

 

 

 

 

 

 



 

# **1.** ***\*概述\****

## **1.1.** ***\*编写目的\****

人工操作的效率极低，出错率也高，现在客户越来越多，现有的人力已经无法满足及时快速的无问题的给客户进行安装和升级。同时未来也希望将升级移交给其他团队（甚至可能是客户自己）执行，而不是由研发来对客户环境进行升级。

基于此对升级流程进行梳理简化，对升级流程进行自动化处理，满足简化升级；

 

 

## **1.2.** ***\*专有名词\****

| 序号 | 名词          | 解释                                                         |
| ---- | ------------- | ------------------------------------------------------------ |
| 1    | 车组          | 在中台，车组为一抽象概念，可以是具体的车队、车组或组织等     |
| 2    | 司机          | 在中台，司机为一抽象概念，可以是具体的司机、从业人员、乘务员等 |
| 3    | 注册          | 设备上线必备流程，通过协议类型，设备编号等信息获取设备相关信息，包括设备authId(鉴权码) |
| 4    | 鉴权          | 808协议系列设备上线必备流程，在注册流程之后。通过设备authId校验设备合法，合法则返回设备相关信息 |
| 5    | base-mfec-sdk | MFEC为Model Field Expansion Capability的缩写，中文名称：模型字段扩展能力，此SDK主要提供基于中台现有模型的扩展能力封装，行业层引入此SDK后，可以方便的自定义扩展字段此SDK为在firefly-V2.12.2内部改造去除原base-metadata-service组件时新增，改造为基于数据库本身json字段模型扩展能力方式 |
|      |               |                                                              |
|      |               |                                                              |

 



## **1.3.** ***\*环境要求\****

| 序号 | 限定类型   | 限定说明                                                     |
| ---- | ---------- | ------------------------------------------------------------ |
| 1    | 安装环境   | Linux(CentOS7.9、Redhat8.3、Rocky linux 9.x、麒麟OS)         |
| 2    | mariadb    | 10.11.6                                                      |
| 3    | Clickhouse | 24.8.4.13                                                    |
| 4    | 必备中间件 | Redis/Nacos/Kafka/JDK(默认X86架构, 国产化环境需要选用ARM架构) |
| 5    | 可选中间件 | CK(含zookeeper)、flink                                       |

 

## **1.4.** ***\*软件特性\****

### **1.4.1.** ***\*开发环境\****

1．linux平台：Centos 7.9 X64

2．开发语言：JAVA、C++ 

### **1.4.2.** ***\*限定条件\****

**{****描述****本方案****的****特殊限定条件****}**

### **1.4.3.** ***\*标准配置要求\****

**{****描述****本方案****的****标准服务器、硬件配置等要求****}**

 

### **1.4.4.** ***\*硬件配置要求\****

（1）单机模式：16C/64G

（2）集群模式：

低于2000设备并发：4*4C/16G（业务+数据库）

2000～10000设备并发：4*8C/32G（业务）+3*4C/16G（数据库）

10000～30000设备并发：4*16C/64G（业务）+3*8C/32G（数据库）

# **2.** ***\*设计原则\****

# **3.** ***\*场景分析\****

![img](F:\projects\quick-upgrade\wps2.jpg) 

 

# **4.** ***\*总体方案设计\****

![img](F:\projects\quick-upgrade\wps3.jpg) 

 

https://docs.qq.com/mind/DREZ0RVdPa0pvaU1P

# **5.** ***\*需求设计\****

## **5.1.** ***\*CICD\****

 

### **5.1.1.** ***\*脚本切点\****

| 原因和动机 | 各组件升级时，需要在合适的时机点执行特定升级操作，如执行sql、调用升级工具接口等。由于目前cicd不具有整体流程编排开放给各团队自行编写的能力，因此cicd将在合适时机点，调用各组件的自定义脚本。这些调用时机点就是自定义脚本切点。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 时机点清单：1、 升级组件安装/升级在所有业务组件安装前，需要执行前置检查，而前置检查需要在升级组件上运行。因此需要在前置检查前安装各团队的升级组件。2、 前置系统资源检查在处理升级动作前，需要确保系统资源满足要求，资源检查作为第一个前置检查进行。所有组件的资源要求均上报，综合满足后，才会进入下一步，否则终止升级。3、 前置业务检查完成系统资源检查后，各组件会进行业务检查，包括业务数据合法性检查等。等所有组件的业务检查均通过，才会进入下一步，否则终止升级。4、 前置升级处理确认环境符合升级条件后，各组件将进行前置升级处理。对于不需要停服即可执行的操作，以及停服前的准备操作，均可放在此处完成。处理完此步，即可进行优雅停服，然后进入组件新版本安装步骤。5、 启动前处理在组件新版本均替换完成后，不会立刻启动服务，而是进行启动前处理。此步是最主要的升级处理，如不兼容sql执行等均在此处理完成。此步处理完，即可进入全系统的优雅启动步骤。6、 启动后处理全环境各组件启动后，即可执行有组件依赖的升级处理，如导入资源包等。此步处理完后，即可进行核心北向功能人工验证。7、 南向开放操作人工验证完成后，即可开放南向入口，使全系统开始加载全部工作负载。开放南向后，系统视作停服升级完成，可正式恢复正常，可以交由客户使用。8、 升级后处理当停服升级完成后，如有需持续处理的数据，可在此步骤完成。 |
| 优先级     |                                                              |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   | 参见总体方案流程                                             |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

### **5.1.2.** ***\*自定义脚本基础设施\****

| 原因和动机 | 为了执行各团队各组件的升级方案，cicd需要提供组件自定义脚本能力。自定义脚本除能执行代码外，还需要使用一些公共功能、公共接口，这些接口由cicd提供。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 1、 脚本语言 cicd提供python作为脚本语言。组件可在项目中打包要执行的python脚本，如放在config等目录，并在组件描述符中，配置某个切点执行某个脚本的某个方法。2、 依赖引用方式 使用自定义python脚本时，可引用各类基础设施模块，cicd提供三种可引用模块：cicd公共功能模块预定义三方模块脚本多文件互引 3、 环境、升级信息cicd在cicd公共功能模块提供环境的信息，如局点/环境id，主机-组件关系，主机信息，多域名清单，升级的起始版本目标版本等。 4、 http客户端 cicd提供python可调用的http客户端库，以便脚本调用各团队升级服务的接口。 5、 sql能力 待讨论确认，各团队使用自身升级服务完成sql执行，还是需要在脚本中执行sql。 |
| 优先级     |                                                              |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   |                                                              |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

 

 

### **5.1.3.** ***\*系统资源检测\****

| 原因和动机 | 升级过程可能占用额外的系统资源，包括内存、磁盘等。如备份会占用磁盘，升级服务启动会占用内存，执行会占用cpu。为避免系统资源不足，导致升级无法完成，需要提前检测系统空闲资源是否满足要求。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | cicd将收集各组件的系统资源要求，汇总后与当前系统资源做比对，如果不满足要求，则终止升级。cicd定义python脚本的接口，来收集各组件的资源需求。有需要的组件，应实现脚本接口，并在组件描述符申明需要上报资源消耗。 需检测的系统资源：内存、磁盘空间 |
| 优先级     |                                                              |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   |                                                              |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

 

 

### **5.1.4.** ***\*flink配置修改\****

| 原因和动机 | 人因要求在升级时修改flink配置，cicd目前不支持修改中间件配置。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 需确认使用场景，是大部分升级都要改，还是就这一次需确认要改那些配置，设计 |
| 优先级     |                                                              |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   |                                                              |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

 

 

### **5.1.5.** ***\*nacos配置修改\****

| 原因和动机 | 目前cicd只在私有化支持nacos配置管理，需要考虑方案在中心化方式下维护nacos配置和变更。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 考虑升级只替换application.properties?update放到日常维护中改？ |
| 优先级     | 低                                                           |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   |                                                              |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

 

### **5.1.6.** ***\*ng配置修改\****

| 原因和动机 | 目前cicd在升级时，不会推送ng配置，如果ng配置修改，需要单独推送。需要考虑在升级时推送ng配置。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   |                                                              |
| 优先级     |                                                              |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   |                                                              |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

 

### **5.1.7.** ***\*打包方案\****

| 原因和动机 | 此次调整，导致cicd需要携带额外的配置文件和信息，因此打包方案需要调整。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   |                                                              |
| 优先级     |                                                              |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   |                                                              |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

 

 

 

### **5.1.8.** ***\*日志方案\****

| 原因和动机 | 本升级方案交给客户执行后， 如果出现问题，如何让客户快速定位问题，或拿回日志，方便研发排查问题。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   |                                                              |
| 优先级     |                                                              |
| 前置条件   |                                                              |
| 功能输入   |                                                              |
| 功能输出   |                                                              |
| 正常流程   |                                                              |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

 

 

 

## **5.2.** ***\*中台\****

 ![img](F:\projects\quick-upgrade\wps4.jpg)

### **5.2.1.** ***\*资源需求检查\****

 

| 原因和动机 | 在执行升级操作前，需对服务器资源（磁盘、CPU、内存）进行评估，确保升级工具、SQL脚本执行以及增量备份等操作有足够的资源支持，避免因资源不足导致升级失败或系统异常。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 在升级前检查以下资源需求：1、 升级工具运行资源：CPU、内存。2、 增量备份SQL资源：磁盘空间（需预估备份文件大小）。3、 数据双写资源（如适用）：额外的磁盘空间和I/O负载。 |
| 优先级     | 低                                                           |
| 前置条件   | 1、升级工具已部署或准备就绪。2、服务器资源监控工具可用（如 df、free、top）。 |
| 功能输入   | 当前版本、目标版本、envInfo环境信息                          |
| 功能输出   | 1、 升级工具服务器资源评估a) 服务器当前空闲 CPU 和内存b) 预估升级工具的内存占用（通过jvm配置的xmx）c) 预估升级工具的CPU占用（累加每个升级脚本的资源）d) 评估结果：通过2、 增量备份SQL资源a) 备份数据库表需要的磁盘空间b) 评估结果：通过3、 数据双写资源评估a) 空闲磁盘空间b) 原始数据空间大小、双写需要的空间大小c) 评估结果：通过4、 评估结果说明a) 通过：资源充足，可继续升级。b) 警告：资源紧张，需人工确认是否继续。c) 失败：资源不足，终止升级流程。 |
| 正常流程   | 正常流程：1、 升级工具需要的cpu、内存评估；a) 升级工具进程的CPU占用（如JVM配置的线程数）。b) 内存需满足升级工具的最小要求（如 -Xms512m -Xmx2g）。c) 升级工具所需临时空间（如解压包、日志文件）2、 增量备份sql需要磁盘评估；a) 评估MySQL和ClickHouse在执行增量备份时所需的磁盘空间、CPU和内存资源，确保备份操作不会因资源不足而失败。b) 占用 ≈ 当前数据总大小（data_length + index_length）* 1.53、 数据双写需要磁盘空间评估；a) 远程评估ClickHouse数据双写磁盘空间方案场景：工具服务与ClickHouse服务器分离，需远程查询CK表空间占用，评估双写磁盘需求。b) 双写磁盘空间 = 原始数据大小 × 2（双副本） + 临时缓冲区（10%~20%）。4、 生成报告：输出资源检查结果。 |
| 异常流程   | 1、 磁盘不足：a) 提示管理员手动扩展磁盘或终止升级，清理临时文件（如日志、缓存）。2、 CPU/内存不足：a) 建议调整升级工具配置（如减少并发线程）。b) 终止升级并报警。 |
| 原型图     |                                                              |
| 性能指标   | 1、 资源检查耗时：≤ 10秒。                                   |
| 约束条件   |                                                              |
| 补充说明   | 1、 磁盘空间公式：a) 总需求 = 升级工具空间 + 增量备份空间2、 数据双写场景的特殊处理a) 若升级涉及数据双写（如新旧版本并行写入），需额外检查：b) 磁盘写入性能（IOPS）。c) 双写期间的磁盘空间需求：d) 双写磁盘需求 = 单日数据增量 × 双写天数 × 2示例阈值：3、 示例阈值a) CPU空闲 ≥ 20%。b) 内存剩余 ≥ 1GB。c) 磁盘剩余 ≥ 备份文件大小的2倍。 |

### **5.2.2.** ***\*数据质量检查\****

| 原因和动机 | 在版本升级前，需确保数据质量符合目标版本的要求，避免因脏数据、格式不兼容或业务规则变更导致升级失败或数据异常。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 1、 版本适用性检查：a) 支持配置版本范围（如 2.16.5~2.16.9），仅当升级源版本或目标版本在范围内时执行检查。2、 数据质量检查项：a) 脏数据检测（如空值、非法字符、违反唯一约束）。b) 数据兼容性（如字段类型、枚举值变更）。c) 业务规则校验（如金额不能为负、时间戳范围）。 |
| 优先级     | 中（影响升级成功率，但非所有版本均需检查）。                 |
| 前置条件   | 1、 数据库连接信息已配置。2、 目标版本的数据质量规则已定义（如通过配置文件）。 |
| 功能输入   | 升级源版本、升级目标版本、环境信息                           |
| 功能输出   | 1、 、通过：所有检查项均符合阈值。2、 警告：部分检查项超出阈值，但可继续升级（如记录日志）。3、 失败：关键检查项不通过（如主键冲突），终止升级。 4、 **报告示例：**[数据质量检查报告]1. 检查项: 必填字段空值检测  - 结果: 失败（发现 15 条空值记录，阈值 0）  - 建议: 执行 `UPDATE orders SET user_id=0 WHERE user_id IS NULL;`2. 检查项: 金额负数检测  - 结果: 通过（0 条异常记录） |
| 正常流程   | 1、 解析版本范围：a) 若当前版本或目标版本在 min_version~max_version 范围内，执行检查。2、 执行SQL检查：a) 运行配置的SQL语句，统计异常记录数。3、 比对阈值：a) 若异常数 ≤ threshold，标记为通过。b) 生成报告：输出通过/警告/失败结果。![img](F:\projects\quick-upgrade\wps5.jpg) |
| 异常流程   | 1、 版本不匹配：跳过检查并记录日志。2、 SQL执行失败：终止检查并报错（如语法错误或表不存在）。3、 数据库连接超时：重试3次后终止升级。4、 数据库不存在，跳过检查并记录日志 |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   | 1、 、仅支持SQL兼容的数据库（MySQL、ClickHouse等）。2、 需提前定义检查规则，不支持动态生成SQL。 |
| 补充说明   | 1、脏数据手动执行修复脚本；                                  |

### **5.2.3.** ***\*获取兼容信息\****

| 原因和动机 | 在数据升级过程中，需明确每条SQL脚本和升级工具的兼容性范围，避免因版本不匹配导致升级失败或数据损坏。通过预检兼容性，可决定是否支持不停服滚动升级或必须停服升级。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 1、 标记兼容版本：a) 为每条SQL脚本和升级工具标注兼容的最小版本（如 compatible_version: 2.16.7）。2、 兼容性判断：a) 根据源版本和目标版本，判断是否需要执行该SQL或工具。b) 规则：仅当 源版本 >= compatible_version 时兼容。3、 不兼容处理：a) 输出不兼容的SQL/工具列表及说明。4、 升级模式决策：a) 兼容版本：支持不停服滚动升级。b) 不兼容版本：必须停服升级。 |
| 优先级     | 高（直接影响升级策略和成功率）                               |
| 前置条件   | 1、 所有SQL脚本和工具已标注兼容版本（如通过元数据文件）。2、 源版本和目标版本已明确。 |
| 功能输入   | 1、 源版本号（如 2.16.6）。2、 目标版本号（如 2.16.9）。     |
| 功能输出   | 兼容报告[兼容性检查结果]  1. SQL: update_V2.16.7.sql   - 兼容性: 通过（源版本 2.16.6 >= 兼容版本 2.16.7? ❌ 不兼容）   - 影响: 修改orders表结构   - 建议: 需停服升级  2. 工具: migrate_data_tool.sh   - 兼容性: 通过（源版本 2.16.6 >= 兼容版本 2.16.5? ✅ 兼容）   - 影响: 迁移用户历史数据 升级模式：不停服滚动升级 或 停服升级 |
| 正常流程   | 1、 解析版本号：a) 提取源版本（src_version）和目标版本（dst_version）。2、 遍历检查SQL/工具：a) 对每条记录，检查 src_version >= compatible_version。3、 生成报告：a) 输出兼容性结果和升级模式建议。 |
| 异常流程   | 1、 版本号格式错误：a) 终止并提示“版本号格式不合法”。2、 未标注兼容版本：a) 默认视为不兼容，要求人工确认。 |
| 原型图     |                                                              |
| 性能指标   | 1、 检查耗时 ≤ 1秒（百级脚本规模）。2、 支持并发检查。       |
| 约束条件   | 1、 版本号需符合语义化版本规范（如 2.16.7）。2、 仅支持预定义的兼容性规则，不支持动态推断。 |
| 补充说明   |                                                              |

### **5.2.4.** ***\*升级耗时评估\****

| 原因和动机 | 在升级过程中，准确评估关键SQL和工具的执行耗时，有助于：1、 制定合理升级窗口：避免因执行超时影响业务连续性。2、 优化资源分配：识别长耗时任务，优先并行化处理。3、 风险预警：提前发现潜在性能瓶颈，减少升级失败风险。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 1、 评估范围：a) 仅评估耗时较久的SQL和工具（执行时间 > 10秒）。b) 分阶段统计：停服前、停服中、服务启动后。2、 评估方法：a) 基于数据量（GB/MB/条）和配置处理速率（如 50MB/s）动态计算耗时。b) 支持执行中动态校准（实际速率偏差 >20%时调整预估）。3、 输出建议：a) 分阶段耗时报告 + 长耗时任务优化建议（如拆分或并行化）。 |
| 优先级     | 中（影响升级窗口规划，但非阻塞性）                           |
| 前置条件   | 1、 升级任务已标记阶段。2、 数据量可获取（通过查询或配置）。 |
| 功能输入   | 源版本、目标版本、数据源、环境信息 SQL/工具的阶段、数据量、速率配置 |
| 功能输出   | [升级耗时评估]  1. 停服前阶段（并行）：   - migrate_user_data.sql: 100GB @ 50MB/s ×4 → 8分32秒  2. 停服中阶段（串行）：   - alter_orders.sql: 3分20秒  3. 服务启动后阶段：   - rebuild_indexes.sh: 4分10秒  ----------------------------------  总耗时: 15分02秒 \| 关键任务: migrate_user_data.sql  [动态调整] 实际速率较预估+12%，已修正后续任务耗时 |
| 正常流程   | 1、 初始化检查a) 校验输入参数完整性（版本号、数据源连接、任务元数据）。b) 确认数据量可获取（通过查询或配置）。2、 分阶段耗时计算a) 停服前阶段：并行任务取最大耗时。b) 停服中阶段：串行任务累加耗时。c) 服务启动后阶段：非阻塞任务单独统计3、 动态校准a) 每30秒采集实际处理量，计算实时速率b) 若 \|actual_speed - configured_speed\| / configured_speed > 0.2，则修正剩余任务预估：4、 报告生成a) 按阶段输出耗时，标记超阈值任务（如 >5分钟）。b) 提供优化建议（如增加并行度、拆分大表）。 |
| 异常流程   |                                                              |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   |                                                              |
| 补充说明   |                                                              |

### **5.2.5.** ***\*数据升级工具\****

| 原因和动机 | 在CICD流程中，各组件需提供标准化的数据升级工具，由CICD在升级的各个阶段调用，确保：1、 流程自动化：减少人工干预，提升升级效率。2、 执行可控性：支持分阶段（停服前/中/后）执行和编排。3、 幂等与可重入：处理执行中断或重复升级场景。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 1、 数据升级操作：a) 数据备份：全量/增量备份源数据。b) SQL执行：执行版本相关的DDL/DML脚本。c) 工具调用：数据清理、数据转换、校验等。2、 阶段划分：a) 停服前：非阻塞操作（如备份、预检查）。b) 停服中：阻塞性操作（如表结构变更、数据迁移）。c) 服务启动后：后置任务（如索引重建、数据一致性校验）。3、 核心特性：a) 编排能力：通过配置定义执行顺序和依赖。b) 幂等执行：记录执行状态，避免重复执行。c) 断点续升：异常中断后可从断点继续。 |
| 优先级     | 高（直接影响升级流程的可靠性和自动化程度）                   |
| 前置条件   | 1、 数据源连接信息（IP/端口/认证）已配2、 升级脚本和工具已按版本规范存放（如V2.16.7/upgrade/） |
| 功能输入   | fromVersion：升级起始版本（示例：V2.16.6）toVersion：升级目标版本（示例：V2.16.7或V2.16.7-P1-T1）src/dst：源/目标数据源（可相同）（示例：MySQL@10.0.0.1:3306）stage：执行阶段（pre_stop/in_stop/post_start）（示例：in_stop）envInfo：局点环境信息（如集群ID）（示例：{"cluster_id":"bj-01"}） |
| 功能输出   | 执行摘要日志：[SUCCESS] 执行完成：alter_orders_table.sql（耗时：2分30秒）[SKIPPED] 已跳过：backup_legacy_data.sh（历史记录显示已成功） 状态记录：数据库记录（如upgrade_log表），字段包括：task_id, version_from, version_to, stage, task_name, status, start_time, end_time |
| 正常流程   | 1、 初始化：a) 校验输入参数合法性（版本号、数据源连通性）b) 查询upgrade_log表，过滤已成功任务2、 任务编排：a) 根据配置按顺序执行当前阶段任务3、 执行与监控：a) 每个任务执行后更新状态（成功/失败）b) 失败时终止流程并记录断点4、 清理与报告：a) 释放临时资源（如关闭数据库连接）b) 输出执行摘要日志 |
| 异常流程   | 1、 任务执行失败：a) 回滚当前任务（如SQL事务）b) 记录失败状态c) 终止流程并告警2、 重复执行检测：a) 跳过upgrade_log中状态为SUCCESS的任务： |
| 原型图     |                                                              |
| 性能指标   | 任务调度延迟：≤50ms/任务状态查询响应：≤10ms最大并行任务数：≤CPU核心数的80% |
| 约束条件   | 1、 版本规范：版本号需符合语义化（如V2.16.7-P1）2、 数据库支持：需支持事务（如MySQL、PostgreSQL）3、 工具兼容性：仅支持Linux/Windows可执行脚本或Python/Java工具 |
| 补充说明   | 1、 日志打印参考日志方案2、 输出执行摘要日志，升级人员通过日志查看升级进度；3、 输出详细日志，方便问题排查；4、 功能增强说明在原有数据升级工具基础上，增加对局点差异化升级内容的支持，通过局点ID过滤需要执行的SQL和工具。 |

## **5.3.** ***\*FT\****

### **5.3.1.** ***\*资源需求检查\****

| 原因和动机 |      |
| ---------- | ---- |
| 功能描述   |      |
| 优先级     |      |
| 前置条件   |      |
| 功能输入   |      |
| 功能输出   |      |
| 正常流程   |      |
| 异常流程   |      |
| 原型图     |      |
| 性能指标   |      |
| 约束条件   |      |
| 补充说明   |      |

### **5.3.2.** ***\*数据质量检查\****

| 原因和动机 | 在版本升级前，需确保数据质量符合目标版本的要求，避免因脏数据、格式不兼容或业务规则变更导致升级失败或数据异常。 |
| ---------- | ------------------------------------------------------------ |
| 功能描述   | 1、 版本适用性检查：a) 支持配置版本范围（如 2.16.5~2.16.9），仅当升级源版本或目标版本在范围内时执行检查。2、 数据质量检查项：a) 脏数据检测（如空值、非法字符、违反唯一约束）。b) 数据兼容性（如字段类型、枚举值变更）。c) 业务规则校验（如金额不能为负、时间戳范围）。 |
| 优先级     | 中（影响升级成功率，但非所有版本均需检查）。                 |
| 前置条件   | 1、 数据库连接信息已配置。2、 目标版本的数据质量规则已定义（如通过配置文件）。 |
| 功能输入   | 升级源版本、升级目标版本、环境信息                           |
| 功能输出   | 1、 、通过：所有检查项均符合阈值。2、 警告：部分检查项超出阈值，但可继续升级（如记录日志）。3、 失败：关键检查项不通过（如主键冲突），终止升级。 4、 **报告示例：**[数据质量检查报告]1. 检查项: 必填字段空值检测  - 结果: 失败（发现 15 条空值记录，阈值 0）  - 建议: 执行 `UPDATE orders SET user_id=0 WHERE user_id IS NULL;`2. 检查项: 金额负数检测  - 结果: 通过（0 条异常记录） |
| 正常流程   | 1、 解析版本范围：a) 若当前版本或目标版本在 min_version~max_version 范围内，执行检查。2、 执行SQL检查：a) 运行配置的SQL语句，统计异常记录数。3、 比对阈值：a) 若异常数 ≤ threshold，标记为通过。b) 生成报告：输出通过/警告/失败结果。![img](F:\projects\quick-upgrade\wps6.jpg) |
| 异常流程   | 1、 版本不匹配：跳过检查并记录日志。2、 SQL执行失败：终止检查并报错（如语法错误或表不存在）。3、 数据库连接超时：重试3次后终止升级。4、 数据库不存在，跳过检查并记录日志 |
| 原型图     |                                                              |
| 性能指标   |                                                              |
| 约束条件   | 1、 、仅支持SQL兼容的数据库（MySQL、ClickHouse等）。2、 需提前定义检查规则，不支持动态生成SQL。 |
| 补充说明   | 1、脏数据手动执行修复脚本；                                  |

### **5.3.3.** ***\*获取兼容信息\****

| 原因和动机 |            |
| ---------- | ---------- |
| 功能描述   |            |
| 优先级     |            |
| 前置条件   |            |
| 功能输入   |            |
| 功能输出   |            |
| 正常流程   | 正常流程： |
| 异常流程   |            |
| 原型图     |            |
| 性能指标   |            |
| 约束条件   |            |
| 补充说明   |            |

 

### **5.3.4.** ***\*升级耗时评估\****

 

| 原因和动机 |            |
| ---------- | ---------- |
| 功能描述   |            |
| 优先级     |            |
| 前置条件   |            |
| 功能输入   |            |
| 功能输出   |            |
| 正常流程   | 正常流程： |
| 异常流程   |            |
| 原型图     |            |
| 性能指标   |            |
| 约束条件   |            |
| 补充说明   |            |

 

### **5.3.5.** ***\*数据升级\****

 

| 原因和动机 |            |
| ---------- | ---------- |
| 功能描述   |            |
| 优先级     |            |
| 前置条件   |            |
| 功能输入   |            |
| 功能输出   |            |
| 正常流程   | 正常流程： |
| 异常流程   |            |
| 原型图     |            |
| 性能指标   |            |
| 约束条件   |            |
| 补充说明   |            |

 

### **5.3.6.** ***\*个人中心-工具上传\*******\*自动化\****

 

| 原因和动机 |            |
| ---------- | ---------- |
| 功能描述   |            |
| 优先级     |            |
| 前置条件   |            |
| 功能输入   |            |
| 功能输出   |            |
| 正常流程   | 正常流程： |
| 异常流程   |            |
| 原型图     |            |
| 性能指标   |            |
| 约束条件   |            |
| 补充说明   |            |

 

## **5.4.** ***\*crocus\****

 

## **5.5.** ***\*s17\****

 

## **5.6.** ***\*人因\****

 

# **6.** ***\*中台（待定）\****

## **6.1.** ***\*整体方案\****

### 6.1.1. 升级流程

![img](F:\projects\quick-upgrade\wps7.jpg) 

 绿色部分是CICD串流程切点，切点处调用升级工具提供的接口能力；

 蓝色部分是CICD串流向需要执行的内容；

 红色部分人工介入修复工具和测试验证；

### 6.1.2. 升级工具

![img](F:\projects\quick-upgrade\wps8.jpg) 

 升级工具提供统一的升级能力，由各组件实现升级工具，升级工具框架集成各组件提供的升级插件；

升级工具通过CICD管理维护；

#### **6.1.2.1.** ***\*功能说明\****

1. **升级插件管理**

a. 包含SPI接口定义和SPI插件管理，支持插件的动态加载和卸载，确保系统的灵活性和可扩展性。

2. **数据源管理**

a. 管理源数据源和目标数据源的列表，支持每个组件单独设置数据源。

b. 各插件根据数据源类型匹配相应的连接配置。

c. 示例配置：

![img](F:\projects\quick-upgrade\wps9.png)

1. **升级****执行器**

a. 负责执行从当前版本到目标版本的SQL和工具，确保在升级过程中所有操作的顺序和依赖关系得到满足。

2. **通用升级工具**

a. 提供待定的通用功能，支持不同场景下的升级需求，如数据迁移、格式转换等。

3. **对外提供接口能力**

a. 提供升级评估、数据升级等操作的API接口，支持外部系统的集成和调用。

#### **6.1.2.2.** ***\*插件\*******\*能力\****

升级插件是整个升级框架的核心，提供以下功能模块：

1. **资源需求检查**

a. 磁盘需求检查：评估升级过程中所需的磁盘空间，包括备份、临时文件和增量数据的存储需求。

b. 中间件资源需求检查：检查数据库、缓存、消息队列等中间件的资源使用情况，确保在升级过程中不会因资源不足导致服务中断。

2. **数据质量检查**

a. 脏数据检测：识别数据中的空值、格式错误等问题，确保数据的完整性和有效性。

b. 重复数据检测：检查唯一性约束，防止因重复数据导致的业务逻辑错误。

c. 逻辑错误检测：验证字段值范围和业务规则，确保数据符合预期的逻辑关系。

3. **版本兼容性检查**

a. SQL兼容性：检查待执行的SQL脚本与当前版本的兼容性，确保在升级过程中不会引入不兼容的变更。

b. 需求兼容性：评估新版本对现有功能的影响，确保升级后系统的稳定性。

4. **升级耗时评估**

a. 针对耗时较长的SQL或工具，评估其执行时间，帮助制定合理的升级窗口。

b. 通过数据量和配置的处理速率动态计算预估耗时，并支持执行过程中的动态调整。

5. **数据升级****工具**

a. 提供增量SQL备份、SQL脚本、数据清理和数据刷写等功能，确保数据在升级过程中的安全和一致性。

#### **6.1.2.3.** ***\*CICD\*******\*维护\****

升级工具通过CICD进行版本维护，确保每次升级都能在稳定的环境中进行。版本控制：所有升级脚本和工具通过版本控制系统管理，确保可追溯性和一致性。

自动化部署：通过CICD管道自动化执行升级流程，减少人工干预，提高效率和准确性。

监控与反馈：在升级过程中实时监控各项指标，及时反馈升级状态，确保问题能够快速定位和解决。

#### **6.1.2.4.** ***\*开发流程\****

 升级工具服务定义SPI接口sdk，各个组件单独创建一个modul实现升级插件，升级插件手动deploy发布到仓库；

升级工具服务引入各组件提供的升级插件；

 升级工具打包的时候解压升级插件的中升级项配置文件，并打包到发布的压缩包中，方便升级出问题时，临时调整sql和执行阶段；

 升级项配置文件解释：每个版本一个升级配置项文件，文件包含sql和工具方法的入口信息，执行升级的时候按顺序执行sql和调用工具；

 升级时，通过CICD部署升级工具，CICD在停服前、停服中、服务启动后等切点调用升级工具接口；

![img](F:\projects\quick-upgrade\wps10.jpg) 

### **6.1.3.** ***\*关键模块设计\****

#### **6.1.3.1.** ***\*升级执行器\****

 升级执行器是整个升级框架的核心组件，负责根据输入的源版本和目标版本，从升级配置中读取需要执行的SQL和工具，并按照编排配置执行相应的任务。它确保在升级过程中各项操作的顺序和依赖关系得到满足。

 ![img](F:\projects\quick-upgrade\wps11.jpg)

##### **6.1.3.1.1.** ***\*组件结构\****

升级执行器的主要组件包括：

1、 版本管理模块：负责版本的兼容性检查。

2、 任务获取模块：从配置中获取需要执行的SQL和工具。

3、 编排管理模块：管理任务的执行顺序和阶段。

4、 执行管理模块：负责实际执行任务并记录结果。

5、 日志与报告模块：记录执行过程中的日志，并生成最终报告。

##### **6.1.3.1.2.** ***\*详细流程\****

##### **6.1.3.1.3.** ***\*版本管理\****

功能：检查源版本和目标版本的兼容性。

实现：

从配置中读取支持的版本范围。

比较输入的源版本和目标版本，确保它们在支持的范围内。

##### **6.1.3.1.4.** ***\*任务获取\****

功能：根据版本信息获取需要执行的SQL和工具。

实现：

遍历升级配置，筛选出与当前版本相关的任务。

##### **6.1.3.1.5.** ***\*编排管理\****

功能：管理任务的执行顺序和阶段。

实现：

根据编排配置确定任务的执行顺序。

支持停服前、停服中、服务启动后等不同阶段的任务。

##### **6.1.3.1.6.** ***\*执行管理\****

功能：执行任务并记录结果。

实现：

逐个执行任务，捕获执行结果（成功、失败、跳过）。

记录每个任务的执行时间和状态。

##### **6.1.3.1.7.** ***\*日志与报告\****

功能：记录执行过程中的日志，并生成最终报告。

实现：

记录每个任务的执行状态。

生成执行摘要，输出总耗时和各阶段耗时。

##### **6.1.3.1.8.** ***\*配置示例\****

###### **6.1.3.1.8.1.** ***\*升级项配置（upgrade_tasks_V2.16.7.properties）\****

sql.{uid}.id: 每条SQL的唯一标识符，用于在执行时引用。

sql.{uid}.description: 对SQL操作的简要描述，便于理解其功能。

sql.{uid}.file: SQL脚本的文件名，执行时需要读取该文件。

sql.{uid}.stage: 指定该SQL在升级过程中的执行阶段（如pre_stop、in_stop、post_start）。

tool.{uid}.id: 每个工具的唯一标识符，用于在执行时引用。

tool.{uid}.description: 对工具操作的简要描述，便于理解其功能。

tool.{uid}.package: 工具方法的包名，执行时需要调用该方法。

tool.{uid}.stage: 指定该工具在升级过程中的执行阶段。

![img](F:\projects\quick-upgrade\wps12.png)

###### **6.1.3.1.8.2.** ***\*升级项编排配置（upgrade_orchestration_V2.16.7.properties）\****

sql.backup_legacy_data.stage: 指定backup_legacy_data SQL的执行阶段，优先于主配置文件中的阶段。

tool.validate_schemas.stage: 指定validate_schemas工具的执行阶段，确保在升级前执行。

![img](F:\projects\quick-upgrade\wps13.png)

 

#### **6.1.3.2.** ***\*数据源管理\****

数据源管理模块负责管理不同类型的数据源，包括MySQL、ClickHouse（CK）和Redis。每个组件可以单独配置数据源，以支持多个数据实例的部署需求

##### **6.1.3.2.1.** ***\*数据源配置示例\****

![img](F:\projects\quick-upgrade\wps14.png)

#### **6.1.3.3.** ***\*升级插件module\****

##### **6.1.3.3.1.** ***\*SPI接口定义\****

 包括资源需求检查、数据质量检查、获取兼容信息、升级耗时评估、数据备份清理等接口；

###### **6.1.3.3.1.1.** ***\*资源需求检查\****

![img](F:\projects\quick-upgrade\wps15.png)

###### **6.1.3.3.1.2.** ***\*数据质量检查\****

![img](F:\projects\quick-upgrade\wps16.png)

###### **6.1.3.3.1.3.** ***\*获取兼容信息\****

![img](F:\projects\quick-upgrade\wps17.png)

###### **6.1.3.3.1.4.** ***\*升级耗时评估\****

![img](F:\projects\quick-upgrade\wps18.png)

###### **6.1.3.3.1.5.** ***\*备份清理\****

![img](F:\projects\quick-upgrade\wps19.png)

###### **6.1.3.3.1.6.** ***\*环境信息类\****

![img](F:\projects\quick-upgrade\wps20.png)

##### **6.1.3.3.2.** ***\*目录结构\****

![img](F:\projects\quick-upgrade\wps21.png)

##### **6.1.3.3.3.** ***\*升级工具调用\****

 在升级配置项的Properties文件中，添加调用工具的包路径。升级执行器将根据这些路径动态加载和执行相应的升级工具。这种设计提高了系统的灵活性和可扩展性，允许在不同版本间轻松切换和管理工具。

 所有升级工具需实现统一的接口，以确保执行的一致性

 

![img](F:\projects\quick-upgrade\wps22.png)

##### **6.1.3.3.4.** ***\*生成升级项配置（sql+工具进行编排）\****

##### **6.1.3.3.5.** ***\*升级插件deploy\****

 手动deploy到仓库

#### **6.1.3.4.** ***\*对外接口\****

**1、*****\*升级前评估\****

(1) 包括：资源需求检查、数据质量检查、获取兼容信息、升级耗时评估

(2) 输入

① currentVersion，升级开始版本，示例：V2.16.6

② tagVersion，升级结束版本，示例：V2.16.7，或V2.16.7-P1-T1

③ src数据源、dst数据源

④ eninfo，局点环境信息

(3) 输出

① 资源需求检查结果；

② 数据质量检查结果;

③ 是否兼容结果；

④ 耗时评估结果；

(4) 异常

① 执行失败中断执行，人工处理异常；

**2、*****\*数据升级\****

(1) 数据升级包括sql脚本执行、数据升级工具执行、通用工具执行，执行阶段有停服前、停服中、服务启动后；

(2) 输入

① currentVersion，升级开始版本，示例：V2.16.6

② tagVersion，升级结束版本，示例：V2.16.7，或V2.16.7-P1-T1

③ src数据源、dst数据源

④ 执行阶段（停服前、停服中、服务启动后）

⑤ eninfo，局点环境信息

⑥ 升级服务名

(3) 输出

① 执行结果日志；

(4) 异常

① 执行失败中断执行，人工处理异常；

#### **6.1.3.5.** ***\*服务优雅停止/启动\****

##### **6.1.3.5.1.** ***\*服务\*******\*停止前\*******\*从nacos下线\****

停止服务时，服务先从nacos中下线，避免nacos-client主动发现节点下线延迟，把请求路由到停止的服务节点；

CICD停止服务前，先把服务从nacos下线，等待5秒（nacos-client配置的发现间隔），然后再停止服务；

##### **6.1.3.5.2.** ***\*服务停止时异步任务优雅结束\****

1、异步任务想要优雅退出，必须先说明下linux kill命令：

l kill：默认发送SIGTERM信号，进程可以捕获并执行清理操作。

l kill -9：发送SIGKILL信号，进程无法捕获，立即终止进程，不会执行清理操作。

2、CICD在停止进程时，建议先使用kill（即SIGTERM）来尝试正常终止进程。如果15秒进程未退出，再使用kill -9（即SIGKILL）强制终止进程。

3、对于耗时较长的异步任务，需要识别程序中断是否影响，对于影响业务的需要优雅退出；或重启后检测异步任务是否状态是否正常；

##### **6.1.3.5.3.** ***\*服务停止时Kafka消费正常退出\****

这里只列举java怎么正常退出kafka消费者

###### **6.1.3.5.3.1.** ***\*kafka手动消费者退出\****

@Autowired

private KafkaConsumer<String, String> consumer;

 

@Bean

public KafkaConsumer<String, String> kafkaConsumer() {

  Properties props = new Properties();

  props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);

  props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);

props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,

……

  consumer = new KafkaConsumer<>(props);

  consumer.subscribe(Collections.singletonList("test-topic"));

  return consumer;

}

 

@PreDestroy

public void destroy() {

  if (consumer != null) {

​    consumer.close();

  }

}

 

###### **6.1.3.5.3.2.** ***\*@KafkaListener消费者退出\****

@Autowired

private MessageListenerContainer listenerContainer;

 

@KafkaListener(topicPattern = KafkaTopicConstant.Config.BASE_CONFIG_EVENT_LINKAGE,

​      containerFactory = "kafkaListenerContainerFactoryBatch",

​      id = KafkaTopicConstant.Config.BASE_CONFIG_EVENT_LINKAGE,

​      idIsGroup = false)

public void process(List<String> list, Acknowledgment ack) {

  ……

}

 

@PreDestroy

public void destroy() {

  MessageListenerContainer listenerContainer = kafkaListenerEndpointRegistry.getListenerContainer(KafkaTopicConstant.Config.BASE_CONFIG_EVENT_LINKAGE);

  if (listenerContainer != null) {

​    listenerContainer.stop();

  }

}

 

##### **6.1.3.5.4.** ***\*服务启动速度和可用状态\****

1、对于服务启动需要保障能正常提供业务后才能注册到nacos中；如中台最后1条gps需要加载全量最后1条gps到内存，未加载完成，用户调用会返回脏数据导致业务不正常；

2、原则异步加载的内容不能影响正常业务调用，如果影响业务请调整为注册nacos前加载；

3、10W设备接入，服务启动控制在2分钟内，服务启动速度优化方法：

(1) 精简依赖：pom.xml移除不必要的库和依赖；

(2) 异步初始化：对于一些可以异步完成的任务，在不影响主流程的情况下，考虑将其放到后台线程中执行；

(3) 代码层面：检查静态块和静态变量的使用，确保它们不会执行耗时操作;

(4) 代码层面：对于Spring等框架的应用，检查是否有过多的Bean定义，考虑使用条件注解（如@Conditional）来控制Bean的创建；

(5) 减少类加载：排查并延迟非必要的组件初始化，直到它们真正被需要时再加载；使用懒加载模式来优化对象创建时机;

4、中台启动异步加载内容，影响正常业务清单：待各模块负责人补充；

## **6.2.** ***\*验证方案\****

## **6.3.** ***\*功能\*******\*测试\****

 