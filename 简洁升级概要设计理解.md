# 简洁升级概要设计理解

## 一、5.2章节之前内容理解

### 1. 修订记录
文档包含了修改历史记录，记录了不同版本的更新内容和作者信息。

### 2. 概述
- **编写目的**：明确了文档的编写目标和适用范围。
- **专有名词**：定义了文档中使用的关键术语和缩写。
- **环境要求**：列出了系统运行所需的硬件和软件环境。
- **软件特性**：描述了系统的主要功能和特性。

### 3. 设计原则
文档遵循了可靠性、可扩展性、易用性等设计原则，确保升级系统的稳定性和灵活性。

### 4. 场景分析
分析了各种升级场景，包括全量升级、增量升级、回滚等不同情况的处理策略。

### 5. 总体方案设计
提出了升级的整体架构和流程，包括CICD集成、升级工具框架、各组件交互方式等。

### 6. 需求设计
#### 5.1 CICD
- **脚本切点**：定义了CICD流程中触发升级操作的关键点。
- **自定义脚本基础设施**：提供了自定义脚本的管理和执行机制。
- **系统资源检测**：升级前检查系统资源是否满足要求。
- **配置修改**：包括flink、nacos、ng等组件的配置更新策略。
- **打包方案**：定义了软件包的构建和发布流程。
- **日志方案**：规范了升级过程中的日志记录格式和要求。

#### 5.2 中台
- **资源需求检查**：评估升级所需的系统资源，确保升级过程顺利进行。
- **数据质量检查**：检测数据中的问题，避免因脏数据导致升级失败。
- **获取兼容信息**：检查版本间的兼容性，确保升级路径的正确性。
- **升级耗时评估**：预估升级所需时间，帮助制定合理的升级窗口。
- **数据升级工具**：提供标准化的数据升级功能，支持分阶段执行和编排。

## 二、第6章节中台部分详细设计理解

### 6.1 整体方案
#### 6.1.1 升级流程
- 绿色部分为CICD串流程切点，调用升级工具接口能力。
- 蓝色部分为CICD串流向需要执行的内容。
- 红色部分为人工介入修复工具和测试验证环节。

#### 6.1.2 升级工具
- **功能说明**：
  - 升级插件管理：支持插件的动态加载和卸载。
  - 数据源管理：管理不同类型的数据源连接。
  - 升级执行器：负责执行SQL和工具，处理顺序和依赖关系。
  - 通用升级工具：提供数据迁移、格式转换等通用功能。
  - 对外接口：提供API接口供外部系统集成调用。

- **插件能力**：
  - 资源需求检查：评估磁盘空间等资源需求。
  - 数据质量检查：检测脏数据、重复数据和逻辑错误。
  - 版本兼容性检查：确保SQL和功能的向后兼容。
  - 升级耗时评估：预估升级操作的执行时间。
  - 数据升级工具：提供SQL备份、数据清理等功能。

- **CICD维护**：
  - 版本控制：通过版本控制系统管理升级脚本和工具。
  - 自动化部署：通过CICD管道自动化执行升级流程。
  - 监控与反馈：实时监控升级状态，及时反馈问题。

- **开发流程**：
  - 定义SPI接口SDK，各组件实现升级插件。
  - 升级工具服务引入各组件提供的插件。
  - 打包时解压升级项配置文件，方便临时调整。

#### 6.1.3 关键模块设计
##### 6.1.3.1 升级执行器
- **组件结构**：
  - 版本管理模块：检查版本兼容性。
  - 任务获取模块：获取需要执行的SQL和工具。
  - 编排管理模块：管理任务执行顺序和阶段。
  - 执行管理模块：执行任务并记录结果。
  - 日志与报告模块：记录日志并生成报告。

- **配置示例**：
  - 升级项配置：定义SQL和工具的ID、描述、文件路径和执行阶段。
  - 升级项编排配置：指定任务的执行阶段和顺序。

##### 6.1.3.2 数据源管理
支持MySQL、ClickHouse、Redis等多种数据源，每个组件可单独配置数据源信息。

##### 6.1.3.3 升级插件module
- **SPI接口定义**：包括资源需求检查、数据质量检查、获取兼容信息、升级耗时评估、备份清理等接口。
- **目录结构**：规范了插件的代码组织方式。
- **升级工具调用**：通过配置文件指定工具的包路径，动态加载和执行。

## 三、总结
升级系统采用了插件化、可扩展的设计架构，通过CICD集成实现了自动化升级流程。中台部分提供了统一的升级工具框架，支持各组件通过SPI接口实现自定义升级逻辑，确保升级过程的可靠性、可控性和可追溯性。系统还提供了完善的资源检查、数据质量检测和版本兼容性验证机制，有效降低了升级风险。