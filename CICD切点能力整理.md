# CICD切点能力整理

## 一、概述
CICD（持续集成/持续部署）在升级流程中提供了多个脚本切点，用于在合适的时机执行特定的升级操作。这些切点允许各组件在升级过程中进行自定义处理，确保升级流程的可靠性和自动化。

## 二、CICD提供的切点能力

### 1. 升级组件安装/升级
- **触发时机**：所有业务组件安装前
- **功能描述**：执行前置检查前安装各团队的升级组件，确保前置检查能在升级组件上运行
- **目的**：为后续升级操作提供基础环境

### 2. 前置系统资源检查
- **触发时机**：处理升级动作前
- **功能描述**：检查系统资源（如CPU、内存、磁盘空间）是否满足升级要求
- **处理逻辑**：
  - 收集各组件的资源需求
  - 与当前系统资源进行比对
  - 若不满足要求，终止升级
  - 若满足要求，进入下一步
- **目的**：避免因资源不足导致升级失败

### 3. 前置业务检查
- **触发时机**：系统资源检查通过后
- **功能描述**：各组件进行业务数据合法性检查
- **处理逻辑**：
  - 所有组件的业务检查均通过后，进入下一步
  - 若任一组件检查失败，终止升级
- **目的**：确保业务数据符合升级条件

### 4. 前置升级处理
- **触发时机**：环境符合升级条件后
- **功能描述**：执行不需要停服即可完成的操作，以及停服前的准备操作
- **包含操作**：
  - 非阻塞性数据备份
  - 配置文件预处理
  - 服务状态检查
- **目的**：减少停服时间，提高升级效率

### 5. 启动前处理
- **触发时机**：组件新版本替换完成后，服务启动前
- **功能描述**：执行最主要的升级处理操作
- **包含操作**：
  - 不兼容SQL执行
  - 数据结构变更
  - 升级脚本执行
- **目的**：确保新版本服务启动前的数据和配置准备就绪

### 6. 启动后处理
- **触发时机**：全环境各组件启动后
- **功能描述**：执行有组件依赖的升级处理
- **包含操作**：
  - 导入资源包
  - 缓存重建
  - 索引优化
- **目的**：完成服务启动后的初始化工作

### 7. 南向开放操作
- **触发时机**：核心北向功能人工验证完成后
- **功能描述**：开放南向入口，使全系统开始加载全部工作负载
- **处理逻辑**：
  - 开放南向接口
  - 系统开始接收和处理外部请求
  - 升级视为完成，系统恢复正常使用
- **目的**：正式启用升级后的系统

### 8. 升级后处理
- **触发时机**：停服升级完成后
- **功能描述**：处理需要持续处理的数据
- **包含操作**：
  - 数据异步迁移
  - 日志清理
  - 性能优化
- **目的**：确保系统在升级后长期稳定运行

## 三、总结
CICD提供的8个脚本切点覆盖了升级流程的各个阶段，从升级前的准备、系统检查，到升级中的核心处理，再到升级后的收尾工作。这些切点机制使得升级流程更加灵活、可靠，并支持各组件根据自身需求进行自定义处理，最终实现自动化、低风险的系统升级。